<script type="text/javascript">
	RED.nodes.registerType('filter', {
		category: 'function',
		color: '#A6BBCF',
		defaults: {
			name: { value: "" },
            property: { value: "payload", required: true },
            propertyType: { value: "msg" },
            asArray: { value: false },
            itemProperty: { value: 'payload' },
            itemPropertyType: { value: 'item' },
            outputs: { value: 1 }
		},
		inputs: 1,
		outputs: 1,
		icon: "function.png",
		label: function() {
			return this.name || "filter";
		},
        oneditprepare: function() {
            $("#node-input-outputs").spinner({
                min:1
            });

            $("#node-input-property").typedInput({ default: this.propertyType || 'msg', types: ['msg', 'flow', 'global'] });

            var updateFilterType = function() {
                if ($("#node-input-filter-type").prop('checked')) {
                    $("#node-input-item-property-row").show();
                }
                else {
                    $("#node-input-item-property-row").hide();
                }
            };
            $("#node-input-filter-type").change(updateFilterType);
            $("#node-input-filter-type").prop('checked', this.asArray);
            updateFilterType();

            var customType = {
                value: 'item',
                label: '____[i].',
                hasValue: true
            };
            $("#node-input-item-property").typedInput({ default: this.itemPropertyType || 'item', types: [customType, 'flow', 'global'] });
            $("#node-input-item-property").val(this.itemProperty);
        },
        oneditsave: function() {
            var node = this;
            node.propertyType = $("#node-input-property").typedInput('type');
            node.asArray = $("#node-input-filter-type").prop('checked');
            node.itemProperty = $("#node-input-item-property").typedInput('value');
            node.itemPropertyType = $("#node-input-item-property").typedInput('type');
        }
	});
</script>

<script type="text/x-red" data-template-name="filter">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row">
        <label for="node-input-outputs"><i class="fa fa-random"></i> Outputs</label>
        <input id="node-input-outputs" style="width: 60px;" value="1">
    </div>

    <div class="form-row">
        <label for="node-input-property">Property</label>
        <input type="text" id="node-input-property" style="width: 70%"/>
    </div>

    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-filter-type" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-filter-type" style="width: 70%;">Filter as an array of messages</label>
    </div>

    <div class="form-row" id="node-input-item-property-row" style="display: none;">
        <label>&nbsp;</label>
        <input type="text" id="node-input-item-property" style="width: 70%"/>
    </div>
</script>

<script type="text/x-red" data-help-name="filter">
    <p>A node that filters incoming message(s) based on configured rules.</p>
</script>
